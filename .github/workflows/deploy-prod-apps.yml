name: üì¶üöÄ Build & deploy Prod release

permissions: write-all

on: workflow_dispatch

jobs:
  gitRelease:
    name: Create git release for Prod app
    runs-on: ubuntu-latest
    outputs:
      new_pubspec_version: "${{ steps.get_new_pubspec_version.outputs.next_pubspec_version }}"
    steps:
      - name: üëÅÔ∏è Check branch validity
        if: github.ref != 'refs/heads/main'
        run: |
          echo "‚ö†Ô∏è Error: you tried to create a release from '${{ github.ref }}' branch but production releases can only be created from 'main' branch"
    
      - name: ‚¨áÔ∏è Checkout repository with tags
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
     
    #  i base my prod version to uat version because of version number 
      - name: üè∑Ô∏èüß™ Get latest UAT release
        id: get_latest_uat_release
        uses: "WyriHaximus/github-action-get-previous-tag@v1"
        with:
          prefix: "release/uat/"
          fallback: 0.0.1

      - name: ‚öôÔ∏è Prepare semantic release configuration
        run: |
          cp .releaserc.prod.json .releaserc.json

      - name: üè∑Ô∏è‚úçÔ∏è Create new Prod release tag
        id: semantic_release_info
        uses: cycjimmy/semantic-release-action@v4.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          semantic_version: 19  

      - name: üìù Make semver.sh executable
        run: chmod +x ./scripts/semver.sh
     
      - name: üìù Edit pubspec version
        id: get_new_pubspec_version
        run: |
          last_uat_release=$(echo "${{ steps.get_latest_uat_release.outputs.tag }}" | sed -E "s/release\/uat\/(.*)/\1/")
          next_pubspec_version=$(./scripts/semver.sh "$last_uat_release" "${{ steps.semantic_release_info.outputs.new_release_version }}")

          echo "pubspec.yaml before update:"
          cat pubspec.yaml
          
          sed -i.bak -E "s/^version: .*/version: $next_pubspec_version/" pubspec.yaml
          
          echo "pubspec.yaml after update:"
          cat pubspec.yaml

          echo "next_pubspec_version=$next_pubspec_version" >> $GITHUB_OUTPUT

      - name: üîÄ Push bump commit with changelog to repository
        uses: stefanzweifel/git-auto-commit-action@v5.0.1
        with:
          commit_message: "chore(*): bump to version ${{ steps.get_new_pubspec_version.outputs.next_pubspec_version }} [skip ci]"
     
      # - name: üè∑Ô∏è‚úçÔ∏è Create new Prod release tag
      #   uses: rickstaa/action-create-tag@v1
      #   with:
      #     tag: "v${{ steps.get_new_pubspec_version.outputs.next_pubspec_version }}"
      #     message: "production release ${{ steps.get_new_pubspec_version.outputs.next_pubspec_version }}"
      #     github_token: ${{ secrets.RELEASE_AUTOMATOR_PAT }}

  # deployProd:
  #   name: Deploy Prod
  #   uses: ./.github/workflows/_deploy-env-apps.yml
  #   needs: gitRelease
  #   secrets: inherit
  #   with:
  #     android-environment-name: 'Android Prod'
  #     android-environment-url: 'https://play.google.com/console/u/0/developers/7200533445067191438/app/4976229890619914417/tracks/internal-testing'
  #     android-package-name: 'com.orevial'
  #     android-release-status: 'completed'
  #     ios-environment-name: 'iOS Prod'
  #     ios-environment-url: 'https://appstoreconnect.apple.com/apps/1292528725/testflight/ios'
  #     short-environment-name: 'Prod'
  #     flavor: 'prod'
  #     new-pubspec-version: ${{ needs.gitRelease.outputs.new_pubspec_version }}
